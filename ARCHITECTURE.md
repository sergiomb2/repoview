# Repoview Architecture Documentation

## Application Overview and Objectives

**Repoview** is a static site generator designed to make YUM repositories easily browseable via a web browser. 

The primary objective of Repoview is to transform the raw metadata of a YUM repository (packages, groups, changelogs) into a set of interlinked, user-friendly HTML pages. This allows users to explore the contents of a repository without needing to use command-line tools like `yum` or `dnf`.

Key features include:
-   **Static Output**: Generates pure HTML/CSS/XML files, requiring no active server-side processing (like PHP or Python) on the hosting web server.
-   **Incremental Generation**: Tracks the state of generated files to only regenerate pages for packages or groups that have changed, significantly speeding up updates for large repositories.
-   **Templating Support**: Uses the Genshi templating engine, allowing for complete customization of the output look and feel.
-   **RSS Feeds**: Optionally generates RSS feeds for the latest package updates.

## Architecture and Design Choices

Repoview is written in **Python 3** and follows a procedural workflow encapsulated within a main controller class.

### Execution Phases

The `Repoview` constructor performs the entire workflow in a deterministic set of phases (mirrored by inline comments in `repoview.py`):

1. **Repository Discovery** – validate the `repodata/repomd.xml`, locate compressed SQLite artifacts (`primary`, `other`, optional `group`), and open database handles. Compressed inputs (`.gz`, `.bz2`, `.xz`) are streamed into temporary files and scheduled for cleanup.
2. **Filesystem Preparation** – resolve the output directory (user-selectable via `-o/--output-dir`, always nested under the repo root), optionally wipe it when `--force` is set, copy the `layout/` assets from the template directory, and initialize the incremental `state.sqlite` database (optionally stored outside the repo via `--state-dir`, with repository-specific filenames hashed via MD5).
3. **Grouping & Package Rendering** – load groups either from `comps.xml`, RPM `Group` tags, or synthesized letter buckets. For each group, build package summaries, render package pages (with change detection, avoiding duplicate renders through an in-memory cache), and then render the group page if any dependency changed.
4. **Aggregate Views** – compute the latest packages list, render `index.html`, and optionally generate `latest-feed.xml` using the RSS template and package data.
5. **State Finalization** – clean up stale files left from previous runs and commit the updated checksums to `state.sqlite` so subsequent invocations stay incremental.

### Core Components

1.  **Data Ingestion (YUM Metadata)**:
    -   Repoview does not parse RPM headers directly. Instead, it relies on the SQLite metadata databases (`primary.sqlite`, `other.sqlite`) generated by `createrepo`.
    -   **Compression Handling**: It automatically detects and decompresses metadata databases (supporting `.gz`, `.bz2`, and `.xz` formats) into temporary files for processing.
    -   It verifies the repository structure by parsing `repodata/repomd.xml`.
    -   It connects to these SQLite databases to query package details, file lists, and changelogs.

2.  **State Management (Incremental Builds)**:
    -   To avoid rebuilding the entire site on every run, Repoview maintains a local SQLite database (`state.sqlite`).
    -   **Checksumming**: For every generated page (package, group, index), a content-based checksum (MD5) is calculated.
    -   **Change Detection**:
        -   Before writing a file to disk, the calculated checksum is compared against the stored checksum in `state.sqlite`. If they match, the file write is skipped.
        -   Package data is memoized per name (`self.written`) so packages that appear in multiple groups are rendered once but referenced many times.
    -   **Stale File Cleanup**: The system tracks which files are visited during a run. Files present in the output directory but not visited are considered "stale" (e.g., deleted packages) and are removed.

3.  **Templating Engine**:
    -   **Genshi**: The application uses Genshi for rendering HTML.
    -   **Structure**:
        -   `index.kid`: The main entry page listing groups and latest packages.
        -   `group.kid`: Displays lists of packages within a specific group.
        -   `package.kid`: detailed view of a single package.
        -   `rss.kid`: XML template for the RSS feed.
    -   **Layout**: A `layout` directory containing static assets (CSS, images) is copied to the output directory.

4.  **Grouping Logic**:
    -   **Comps.xml**: If available, Repoview uses the `comps.xml` file to organize packages into logical groups (e.g., "Development", "System Tools").
    -   **RPM Groups**: As a fallback, it can group packages based on the `Group` tag in the RPM metadata.
    -   **Alphabetical**: It automatically generates "Letter Groups" (Packages A, Packages B, etc.) for easier browsing. These groups share the same rendering pipeline and benefit from the package memoization cache.

### Data Flow

1.  **Initialization**: Parse arguments, setup output directories, initialize state DB.
2.  **Repo Connection**: Connect to `primary` and `other` SQLite databases.
3.  **Group Processing**:
    -   Iterate through each defined group.
    -   For each package in the group, fetch details and changelogs.
    -   Render package page -> Checksum -> Write if changed.
    -   Render group page -> Checksum -> Write if changed.
4.  **Index Generation**: Aggregate group lists and "latest modified" packages to render `index.html`.
5.  **Finalization**: Commit state changes and delete stale files.

### Python Environment

Repoview is built as a self-contained, single-file Python utility (`repoview.py`) designed for ease of deployment and broad compatibility.

#### Core Dependencies

While the application leans heavily on the Python standard library, it requires a few key external modules to function:

-   **Genshi (`genshi.template`)**:
    -   *Role*: The primary templating engine used to render HTML and XML output.
    -   *Usage*: It processes `.kid` template files, injecting Python objects (package lists, repository metadata) into the markup.

-   **RPM Bindings (`rpm`)**:
    -   *Role*: Provides native RPM functionality.
    -   *Usage*: Specifically used for `rpm.labelCompare` to accurately sort and compare package versions (Epoch-Version-Release) and architectures.

-   **Libcomps (`libcomps`)**:
    -   *Role*: Library for parsing `comps.xml` files.
    -   *Usage*: Optional but recommended. It is used to parse group definitions when `comps.xml` is present or specified.

-   **SQLite (`sqlite3`)**:
    -   *Role*: Database Interface.
    -   *Usage*: Used to interact with the YUM metadata databases (`primary.sqlite`, `other.sqlite`) and the internal state tracking database (`state.sqlite`).

#### Code Strategy

-   **Single-File Distribution**: The entire application logic resides in `repoview.py`, making it easy to copy and run without complex installation procedures.
-   **Standard Library First**: It prioritizes standard library modules (`os`, `sys`, `shutil`, `hashlib`, `xml.etree`, `optparse`) to minimize external dependencies.
-   **Compression Support**: It uses standard libraries (`gzip`, `bz2`, `lzma`) to transparently handle compressed metadata files commonly found in repositories.
-   **Graceful Degradation**: The code includes try-except blocks for imports to handle different environment configurations (e.g., falling back to `cElementTree` or different `sqlite` import paths).

## Command Line Arguments

Repoview CLI accepts the following arguments:

| Argument | Type | Default | Description |
| :--- | :--- | :--- | :--- |
| `repodir` | Path | (Required) | The root directory of the repository (containing the `repodata` folder). |
| `-i`, `--ignore-package` | String (Glob) | `[]` | Ignore packages matching the glob pattern (e.g., `*debuginfo*`). Can be specified multiple times. |
| `-x`, `--exclude-arch` | String | `[]` | Exclude packages for specific architectures (e.g., `src`). Can be specified multiple times. |
| `-k`, `--template-dir` | Path | `/usr/share/repoview/templates/default` | Path to a custom directory containing Genshi templates (`*.kid`) and layout files. |
| `-o`, `--output-dir` | Path | `repoview` | Subdirectory (within `repodir`) where HTML files will be generated. |
| `-s`, `--state-dir` | Path | `[output-dir]` | Directory to store the `state.sqlite` database. Defaults to the output directory. |
| `-t`, `--title` | String | `"Repoview"` | Title of the repository to be displayed on generated pages. |
| `-u`, `--url` | URL | `None` | Base URL of the repository. Required for generating valid RSS feed links. |
| `-f`, `--force` | Flag | `False` | Force regeneration of all pages, ignoring the state database checksums. |
| `-q`, `--quiet` | Flag | `False` | Suppress standard output status messages. Only fatal errors are printed. |
| `-c`, `--comps` | Path | `None` | Path to an alternative `comps.xml` file, overriding the one in `repomd.xml`. |
| `-V`, `--version` | Flag | - | Print version number and exit. |
| `-h`, `--help` | Flag | - | Print usage message and exit. |

## Examples

### Basic Usage

Generate repoview pages for a repository located at `/var/www/html/repo`. The output will be in `/var/www/html/repo/repoview`.

```bash
repoview /var/www/html/repo
```

### Custom Title and RSS Feed

Generate pages with a specific title and enable RSS feed generation (requires URL).

```bash
repoview -t "My Enterprise Updates" -u "http://updates.example.com/repo" /var/www/html/repo
```

### Excluding Debug Packages

Skip processing for debuginfo and documentation packages to save time and space.

```bash
repoview -i "*debuginfo*" -i "*doc*" /var/www/html/repo
```

### Force Regeneration

Force a complete rebuild of the site, useful after changing templates or upgrading Repoview.

```bash
repoview --force /var/www/html/repo
```

### Using Custom Templates

Use a custom set of templates located in `~/my-templates`.

```bash
repoview -k ~/my-templates /var/www/html/repo
```

### Custom Output Location

Write the generated site to `/var/www/html/repo/docs` instead of the default `repoview` folder.

```bash
repoview -o docs /var/www/html/repo
```
